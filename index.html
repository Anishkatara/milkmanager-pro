<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
    <title>Anish Dairy - Milk Manager Pro</title>
    <meta name="keywords" content="anish dairy, anish katara, milk manager, dairy management, milk collection app, india dairy software">
    <meta name="description" content="Anish Dairy Milk Manager - Professional dairy management system by Anish Katara.">
    <meta name="author" content="Anish Katara">

    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f9fafb; 
            color: #111827;
            -webkit-tap-highlight-color: transparent;
            overflow-x: hidden;
        }

        .login-container { display:flex; align-items:center; justify-content:center; min-height:100vh; background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); padding:1rem; }
        .login-box { background:#fff; padding:1.5rem; border-radius:1rem; box-shadow:0 20px 25px -5px rgba(0,0,0,.1); width:100%; max-width:420px; }
        .login-header { text-align:center; margin-bottom:1.25rem; }
        .login-photo { width:120px; height:120px; border-radius:50%; margin:0 auto 1rem; display:block; object-fit:cover; border:4px solid #1e3a8a; }
        .login-header h1 { font-size:1.5rem; color:#1e3a8a; margin-bottom:.25rem; font-weight:700; }
        .login-header p { color:#6b7280; font-size:0.95rem; }

        .form-group { margin-bottom:1.2rem; }
        .form-label { display:block; margin-bottom:.5rem; color:#374151; font-weight:600; font-size:.95rem; }
        .form-input, .form-select { 
            width:100%; 
            padding:.85rem; 
            border:2px solid #d1d5db; 
            border-radius:.5rem; 
            font-size:16px;
            transition: border-color 0.2s;
            background: #fff;
        }
        .form-input:focus, .form-select:focus { 
            outline:none; 
            border-color:#3b82f6; 
            box-shadow:0 0 0 3px rgba(59,130,246,.1); 
        }

        .btn { 
            padding:.85rem 1rem; 
            border-radius:.5rem; 
            border:none; 
            cursor:pointer; 
            font-weight:600; 
            display:inline-flex; 
            align-items:center; 
            justify-content:center; 
            gap:.5rem; 
            transition:all .2s;
            min-height:48px;
            font-size:1rem;
        }
        .btn-primary { background:#2563eb; color:#fff; width:100%; }
        .btn-primary:active { background:#1d4ed8; transform: scale(0.98); }
        .btn-secondary { background:#e5e7eb; color:#374151; width:100%; margin-top:.5rem; }
        .btn-secondary:active { background:#d1d5db; transform: scale(0.98); }
        .btn-sm { padding:.4rem .6rem; font-size:.9rem; width:auto; }

        .app-container { display:none; min-height:100vh; }
        .app-container.show { display:flex; flex-direction:column; }

        .header { 
            background:#fff; 
            border-bottom:2px solid #e5e7eb; 
            padding:.85rem 1rem;
            display:flex; 
            align-items:center; 
            gap:1rem; 
            justify-content:space-between;
            z-index:150;
        }
        .header-title { font-weight:700; font-size:1.1rem; flex:1; }
        .menu-btn {
            background: none;
            border: none;
            font-size: 1.8rem;
            cursor: pointer;
            padding: 0.5rem;
            color: #374151;
            min-width: 44px;
            min-height: 44px;
            display: none;
        }

        .sidebar { 
            position:fixed; 
            left:0; 
            top:0; 
            bottom:0; 
            width:280px; 
            background: linear-gradient(to bottom,#1e3a8a,#1e40af); 
            color:#fff; 
            display:none;
            flex-direction:column; 
            padding:1rem; 
            box-shadow:0 10px 15px -3px rgba(0,0,0,.1); 
            z-index:100;
            overflow-y:auto;
        }
        
        .sidebar-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.5);
            z-index: 99;
            display: none;
        }
        .sidebar-overlay.active { display: block; }

        .sidebar-header { display:flex; align-items:center; justify-content:space-between; margin-bottom:1rem; }
        .sidebar-header h1 { font-size:1.1rem; font-weight:700; }

        .sidebar-close { 
            background: transparent; 
            border: none; 
            color: #fff; 
            font-size: 1.8rem; 
            cursor: pointer; 
            padding: 0.25rem;
            line-height: 1;
            min-width: 44px;
            min-height: 44px;
            display: none;
        }

        .sidebar-nav { display:flex; flex-direction:column; gap:.5rem; flex:1; }
        .nav-item { 
            display:flex; 
            align-items:center; 
            gap:.6rem; 
            padding:.9rem; 
            border-radius:.5rem; 
            background:transparent; 
            color:#fff; 
            cursor:pointer; 
            border:none; 
            font-weight:600; 
            text-align:left; 
            transition:all .2s;
            font-size:1rem;
            min-height:48px;
        }
        .nav-item:active { background: #1e40af; }
        .nav-item.active { background:#fff; color:#1e3a8a; }

        .sidebar-footer { margin-top:1rem; }
        .user-info { display:flex; align-items:center; gap:.6rem; background:rgba(255,255,255,.08); padding:.6rem; border-radius:.5rem; margin-bottom:.5rem; }
        .user-avatar { width:40px; height:40px; border-radius:50%; background:linear-gradient(135deg,#3b82f6,#8b5cf6); display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:1.2rem; }

        .bottom-nav {
            position:fixed;
            bottom:0;
            left:0;
            right:0;
            background:#fff;
            border-top:2px solid #e5e7eb;
            display:flex;
            justify-content:space-around;
            padding:0.5rem 0;
            z-index:100;
        }
        .nav-btn {
            flex:1;
            background:none;
            border:none;
            padding:0.75rem;
            cursor:pointer;
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:0.25rem;
            font-size:0.75rem;
            color:#6b7280;
            font-weight:600;
            transition:color 0.2s;
        }
        .nav-btn.active {
            color:#2563eb;
        }
        .nav-btn span:first-child {
            font-size:1.5rem;
        }

        .main-content { 
            padding:1rem;
            flex:1;
            overflow-y:auto;
            padding-bottom:80px;
        }

        .stats-grid { 
            display:grid; 
            grid-template-columns:repeat(2, 1fr); 
            gap:0.75rem; 
            margin-bottom:1rem; 
        }
        .stat-card { 
            background:#fff; 
            padding:1rem; 
            border-radius:.5rem; 
            box-shadow:0 1px 3px rgba(0,0,0,.1); 
            border: 1px solid #e5e7eb;
        }
        .stat-card p { font-size: 0.75rem; color: #6b7280; font-weight: 600; margin-bottom: 0.4rem; }
        .stat-card .stat-value { font-size: 1.25rem; font-weight: 700; }

        .quick-actions { 
            background:#fff; 
            padding:1rem; 
            border-radius:.5rem; 
            box-shadow:0 1px 3px rgba(0,0,0,.1); 
            margin-bottom:1rem; 
        }
        .quick-actions h3 { margin-bottom: 0.75rem; font-weight: 700; font-size: 1rem; }
        .quick-actions-grid { 
            display:grid; 
            grid-template-columns:repeat(3, 1fr); 
            gap:0.75rem; 
        }
        .quick-action-btn {
            padding: 1rem 0.5rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.4rem;
            transition: all 0.2s;
            min-height: 70px;
        }
        .quick-action-btn:active { transform: scale(0.95); }
        .quick-action-btn span:first-child { font-size: 1.5rem; }

        .customers-grid { 
            display:grid; 
            grid-template-columns:1fr; 
            gap:0.75rem; 
        }
        .customer-card { 
            background:#fff; 
            padding:1rem; 
            border-radius:.5rem; 
            box-shadow:0 1px 3px rgba(0,0,0,.1); 
            border: 1px solid #e5e7eb;
            cursor:pointer;
        }
        .customer-card-header {
            display:flex;
            align-items:center;
            gap:0.75rem;
            margin-bottom:0.5rem;
        }
        .customer-avatar {
            width:40px;
            height:40px;
            border-radius:50%;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#fff;
            font-weight:700;
            font-size:1rem;
        }
        .customer-info { flex:1; min-width:0; }
        .customer-name { font-weight:700; font-size:0.95rem; }
        .customer-meta { font-size:0.8rem; color:#6b7280; }
        .customer-badge {
            display:inline-block;
            padding:0.2rem 0.5rem;
            border-radius:0.3rem;
            font-size:0.7rem;
            font-weight:600;
            margin-right:0.25rem;
        }
        .balance-amount {
            font-weight:700;
            font-size:1rem;
        }

        .modal-overlay { 
            display:none; 
            position:fixed; 
            inset:0; 
            background:rgba(0,0,0,0.5); 
            z-index:200;
            overflow-y:auto;
            padding:1rem;
        }
        .modal-overlay.active { display:flex; align-items:flex-start; justify-content:center; padding-top:2rem; }
        .modal { 
            width:100%; 
            max-width:600px; 
            background:#fff; 
            padding:1.5rem; 
            border-radius:.5rem; 
            margin-bottom:2rem;
        }
        .modal-header { 
            display:flex; 
            justify-content:space-between; 
            align-items:center; 
            margin-bottom:1rem; 
            padding-bottom: 1rem;
            border-bottom: 2px solid #e5e7eb;
        }
        .modal-title { font-size:1.2rem; font-weight:700; }
        .modal-close { 
            border:none; 
            background:none; 
            font-size:1.8rem; 
            cursor:pointer; 
            padding:0.25rem;
            line-height:1;
            min-width: 44px;
            min-height: 44px;
        }

        .time-selector {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }
        .time-option {
            padding: 0.75rem;
            border: 2px solid #d1d5db;
            border-radius: 0.4rem;
            cursor: pointer;
            text-align: center;
            font-weight: 600;
            font-size:0.9rem;
            transition: all 0.2s;
            background: #fff;
        }
        .time-option.selected {
            background: #2563eb;
            color: #fff;
            border-color: #2563eb;
        }

        .entry-row, .payment-row {
            padding: 0.75rem 0;
            border-bottom: 1px solid #e5e7eb;
            font-size:0.95rem;
        }
        .entry-row:last-child, .payment-row:last-child {
            border-bottom: none;
        }

        .invoice-section {
            background:#fff;
            padding:1.5rem;
            border-radius:0.5rem;
            margin-bottom:1rem;
        }

        @media (min-width:768px) {
            .menu-btn { display:flex !important; }
            .sidebar { 
                position:relative;
                display:flex !important;
                transform:none;
                width: 256px;
                top:0;
                bottom:auto;
            }
            .sidebar-overlay { display: none !important; }
            .sidebar-close { display: none !important; }
            .bottom-nav { display: none !important; }
            
            .app-container { flex-direction:row; }
            .main-content { 
                padding:1.5rem;
                padding-bottom:2rem;
                margin-left:256px;
            }
            .header { margin-left:256px; display:none; }
            
            .stats-grid { grid-template-columns:repeat(3, 1fr); gap:1rem; }
            .stat-card { padding:1.2rem; }
            .stat-card p { font-size:0.85rem; }
            .stat-card .stat-value { font-size:1.5rem; }
            
            .customers-grid { 
                grid-template-columns:repeat(auto-fill,minmax(300px,1fr));
                gap:1rem;
            }
            .customer-card { padding:1.2rem; }
            
            .quick-actions { padding:1.2rem; }
            .quick-action-btn { min-height:80px; }
            .quick-action-btn span:first-child { font-size: 1.8rem; }

            .modal { max-width:500px; padding:2rem; }
        }

        @media (max-width:767px) {
            .header { display:flex; }
            .menu-btn { display:flex; }
            .sidebar { 
                position:fixed;
                transform: translateX(-100%);
                transition: transform 0.3s ease;
                z-index:150;
                width:280px;
            }
            .sidebar.active { transform: translateX(0); display:flex; }
        }

        .section-title {
            font-size:1.25rem;
            font-weight:700;
            margin-bottom:0.75rem;
        }

        .section-subtitle {
            font-size:0.9rem;
            color:#6b7280;
            margin-bottom:1rem;
        }

        .view-container { display:none; }
        .view-container.active { display:block; }

        @media print {
            .no-print { display: none !important; }
            .bottom-nav { display: none !important; }
            .header { display: none !important; }
            body { background: white; }
        }
    </style>
</head>
<body>
    <div class="login-container" id="loginContainer">
        <div class="login-box">
            <div class="login-header">
                <img src="https://raw.githubusercontent.com/anishkatara/milkmanager-pro/main/assets/logo.png"
     alt="Anish Dairy" class="login-photo">
                <h1>Anish Dairy</h1>
                <p>Milk Collection & Supply Center</p>
            </div>

            <div id="loginForm">
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input id="loginEmail" class="form-input" type="email" placeholder="you@example.com" autocomplete="email" />
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input id="loginPassword" class="form-input" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" autocomplete="current-password" />
                </div>
                <button class="btn btn-primary" onclick="handleLogin()">Sign In</button>
                <button class="btn btn-secondary" onclick="toggleAuthMode()">Create Account</button>
            </div>

            <div id="signupForm" style="display:none;">
                <div class="form-group">
                    <label class="form-label">Full Name</label>
                    <input id="signupName" class="form-input" type="text" placeholder="Your name" autocomplete="name" />
                </div>
                <div class="form-group">
                    <label class="form-label">Email</label>
                    <input id="signupEmail" class="form-input" type="email" placeholder="you@example.com" autocomplete="email" />
                </div>
                <div class="form-group">
                    <label class="form-label">Password</label>
                    <input id="signupPassword" class="form-input" type="password" placeholder="Min 6 characters" autocomplete="new-password" />
                </div>
                <button class="btn btn-primary" onclick="handleSignup()">Create Account</button>
                <button class="btn btn-secondary" onclick="toggleAuthMode()">Back to Sign In</button>
            </div>

            <div id="authMessage" style="margin-top:1rem; display:none; padding:.85rem; border-radius:.5rem; font-size: 0.95rem;"></div>
        </div>
    </div>

    <div class="app-container" id="appContainer">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar(false)"></div>
        
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div style="display:flex; align-items:center; gap:0.5rem;">
                    <img src="https://raw.githubusercontent.com/anishkatara/milkmanager-pro/main/assets/logo.png"
     alt="Logo" style="width:32px; height:32px; border-radius:50%; object-fit:cover;">
                    <h1>Anish Dairy</h1>
                </div>
                <button class="sidebar-close" onclick="toggleSidebar(false)">&times;</button>
            </div>

            <nav class="sidebar-nav">
                <button class="nav-item active" onclick="changeView('dashboard', this)">üìä Dashboard</button>
                <button class="nav-item" onclick="changeView('customers', this)">üë• Customers</button>
                <button class="nav-item" onclick="changeView('entries', this)">üìù Entries</button>
                <button class="nav-item" onclick="changeView('payments', this)">üí∞ Payments</button>
            </nav>

            <div class="sidebar-footer">
                <div class="user-info">
                    <div class="user-avatar" id="userAvatar">U</div>
                    <div style="min-width:0; flex: 1;">
                        <div id="userName" style="font-weight:700; font-size:.9rem;">User</div>
                        <div id="userEmail" style="font-size:.8rem; color:#bfdbfe; overflow:hidden; text-overflow:ellipsis; white-space: nowrap;">user@mail.com</div>
                    </div>
                </div>
                <button class="btn btn-secondary" style="width:100%; font-size:0.9rem;" onclick="handleLogout()">Sign Out</button>
            </div>
        </aside>

        <header class="header">
            <button class="menu-btn" onclick="toggleSidebar(true)">‚ò∞</button>
            <div class="header-title" id="headerTitle">Dashboard</div>
        </header>

        <div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-title" id="modalTitle">Modal</div>
                    <button class="modal-close" onclick="closeModal()">&times;</button>
                </div>
                <div id="modalContent"></div>
            </div>
        </div>

        <main class="main-content">
            <div id="dashboardView" class="view-container active">
                <h2 class="section-title">Dashboard</h2>
                <p class="section-subtitle">Overview of your milk business</p>

                <div id="statsGrid" class="stats-grid"><div style="padding:2rem; text-align:center; color:#6b7280;">Loading...</div></div>

                <div class="quick-actions">
                    <h3>Quick Actions</h3>
                    <div class="quick-actions-grid">
                        <button class="quick-action-btn" style="background:linear-gradient(135deg,#dbeafe,#bfdbfe); color:#2563eb;" onclick="openModal('entry')">
                            <span>üìù</span>
                            <span>Entry</span>
                        </button>
                        <button class="quick-action-btn" style="background:linear-gradient(135deg,#d1fae5,#a7f3d0); color:#059669;" onclick="openModal('payment')">
                            <span>üí∞</span>
                            <span>Pay</span>
                        </button>
                        <button class="quick-action-btn" style="background:linear-gradient(135deg,#e9d5ff,#d8b4fe); color:#7c3aed;" onclick="openModal('customer')">
                            <span>üë§</span>
                            <span>Add</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="customersView" class="view-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:0.5rem;">
                    <h2 class="section-title" style="margin:0;">Customers</h2>
                    <button class="btn btn-primary btn-sm no-print" onclick="openModal('customer')">+ Add</button>
                </div>
                <div id="customersGrid" class="customers-grid"><div style="padding:2rem; text-align:center; color:#6b7280;">Loading...</div></div>
            </div>

            <div id="entriesView" class="view-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:0.5rem;">
                    <h2 class="section-title" style="margin:0;">Entries</h2>
                    <button class="btn btn-primary btn-sm no-print" onclick="openModal('entry')">+ Add</button>
                </div>
                <div id="entriesContainer" class="customers-grid"><div style="padding:2rem; text-align:center; color:#6b7280;">Loading...</div></div>
            </div>

            <div id="paymentsView" class="view-container">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:0.5rem;">
                    <h2 class="section-title" style="margin:0;">Payments</h2>
                    <button class="btn btn-primary btn-sm no-print" onclick="openModal('payment')">+ Add</button>
                </div>
                <div id="paymentsContainer" class="customers-grid"><div style="padding:2rem; text-align:center; color:#6b7280;">Loading...</div></div>
            </div>

            <div id="customerDetailView" class="view-container">
                <div class="no-print" style="display:flex; justify-content:space-between; align-items:center; margin-bottom:1rem; gap:0.5rem;">
                    <button class="btn btn-secondary btn-sm" onclick="changeView('customers')">‚Üê Back</button>
                    <button class="btn btn-primary btn-sm" onclick="generateInvoice()">üìÑ Invoice</button>
                </div>
                <div id="customerDetailContent"></div>
            </div>
        </main>

        <div class="bottom-nav no-print">
            <button class="nav-btn active" onclick="changeView('dashboard', this); updateBottomNav(0);">
                <span>üìä</span>
                <span>Dashboard</span>
            </button>
            <button class="nav-btn" onclick="changeView('customers', this); updateBottomNav(1);">
                <span>üë•</span>
                <span>Customers</span>
            </button>
            <button class="nav-btn" onclick="changeView('entries', this); updateBottomNav(2);">
                <span>üìù</span>
                <span>Entries</span>
            </button>
            <button class="nav-btn" onclick="changeView('payments', this); updateBottomNav(3);">
                <span>üí∞</span>
                <span>Payments</span>
            </button>
        </div>
    </div>

    <script>
        const firebaseConfig = {
          apiKey: "AIzaSyA6bK8TZkVqlyeRw-etHi-MxznRW8jBPJQ",
          authDomain: "anish-milk-app.firebaseapp.com",
          databaseURL: "https://anish-milk-app-default-rtdb.asia-southeast1.firebasedatabase.app/",
          projectId: "anish-milk-app",
          storageBucket: "anish-milk-app.appspot.com",
          messagingSenderId: "17384087601",
          appId: "1:17384087601:web:83db1f8b77780ffde6b510"
        };

        let firebaseInitialized = false;
        try {
            if (typeof firebase !== 'undefined' && firebase.apps) {
                firebase.initializeApp(firebaseConfig);
                firebaseInitialized = true;
            }
        } catch (e) {
            console.error('Firebase init error:', e);
        }

        const auth = firebaseInitialized ? firebase.auth() : null;
        const database = firebaseInitialized ? firebase.database() : null;

        let currentUser = null;
        const UPI_ID = 'katara.anish@axl';
        let currentCustomerMobile = null;
        let selectedTime = 'morning';

        let localData = { customers: [], entries: [], payments: [] };

        function toggleAuthMode() {
            const login = document.getElementById('loginForm');
            const signup = document.getElementById('signupForm');
            if (login.style.display === 'none') {
                login.style.display = 'block';
                signup.style.display = 'none';
            } else {
                login.style.display = 'none';
                signup.style.display = 'block';
            }
        }

        function toggleSidebar(open) {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (window.innerWidth >= 768) return;
            
            if (open) {
                sidebar.classList.add('active');
                overlay.classList.add('active');
                document.body.style.overflow = 'hidden';
            } else {
                sidebar.classList.remove('active');
                overlay.classList.remove('active');
                document.body.style.overflow = '';
            }
        }

        function showAuthMessage(msg, err = false) {
            const el = document.getElementById('authMessage');
            if (!el) return;
            el.style.display = 'block';
            el.textContent = msg;
            el.style.background = err ? '#fee2e2' : '#dcfce7';
            el.style.color = err ? '#b91c1c' : '#065f46';
            setTimeout(() => el.style.display = 'none', 3500);
        }

        async function handleLogin() {
            if (!auth) { showAuthMessage('Firebase not initialized', true); return; }
            const email = document.getElementById('loginEmail')?.value.trim();
            const password = document.getElementById('loginPassword')?.value;
            if (!email || !password) { showAuthMessage('Fill all fields', true); return; }
            try {
                const cred = await auth.signInWithEmailAndPassword(email, password);
                currentUser = cred.user;
                showAuthMessage('Login successful');
                setTimeout(showAppInterface, 300);
            } catch (err) {
                showAuthMessage(err.message || 'Login failed', true);
            }
        }

        async function handleSignup() {
            if (!auth || !database) { showAuthMessage('Firebase not initialized', true); return; }
            const name = document.getElementById('signupName')?.value.trim();
            const email = document.getElementById('signupEmail')?.value.trim();
            const password = document.getElementById('signupPassword')?.value;
            if (!name || !email || !password) { showAuthMessage('Fill all fields', true); return; }
            if (password.length < 6) { showAuthMessage('Password min 6 chars', true); return; }
            try {
                const cred = await auth.createUserWithEmailAndPassword(email, password);
                currentUser = cred.user;
                await database.ref(`users/${currentUser.uid}/profile`).set({ name, email, createdAt: Date.now() });
                showAuthMessage('Account created');
                setTimeout(showAppInterface, 300);
            } catch (err) {
                showAuthMessage(err.message || 'Signup failed', true);
            }
        }

        function handleLogout() {
            if (!confirm('Sign out?')) return;
            auth?.signOut();
            currentUser = null;
            document.getElementById('appContainer').classList.remove('show');
            document.getElementById('loginContainer').style.display = 'flex';
        }

        function showAppInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('appContainer').classList.add('show');
            const email = currentUser?.email || 'user@mail.com';
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userName').textContent = email.split('@')[0];
            document.getElementById('userAvatar').textContent = email[0].toUpperCase();
            loadAllData();
        }

        if (auth) {
            auth.onAuthStateChanged(user => {
                if (user) {
                    currentUser = user;
                    showAppInterface();
                } else {
                    document.getElementById('appContainer').classList.remove('show');
                    document.getElementById('loginContainer').style.display = 'flex';
                }
            });
        }

        function getUserPath(path) {
            return `users/${currentUser?.uid || 'demo'}/${path}`;
        }

        async function loadAllData() {
            renderDashboard();
            try {
                if (database && currentUser?.uid) {
                    const snap = await database.ref(getUserPath('')).once('value');
                    const data = snap.val() || {};
                    localData.customers = data.customers ? Object.values(data.customers) : [];
                    localData.entries = data.entries ? Object.values(data.entries) : [];
                    localData.payments = data.payments ? Object.values(data.payments) : [];
                }
            } catch (err) {
                console.error('Load error:', err);
            }
            renderDashboard();
        }

        async function saveToFirebase(pathKey, arrayData) {
            try {
                if (database && currentUser?.uid) {
                    const obj = {};
                    (arrayData || []).forEach(item => {
                        const key = pathKey === 'customers' ? item.mobile : (item.id || Date.now());
                        obj[key] = item;
                    });
                    await database.ref(getUserPath(pathKey)).set(obj);
                }
            } catch (err) {
                console.error('Save error:', err);
            }
        }

        function renderDashboard() {
            const grid = document.getElementById('statsGrid');
            if (!grid) return;
            const today = new Date().toISOString().split('T')[0];
            
            const milkCollected = localData.entries.filter(e => {
                const c = localData.customers.find(cu => cu.mobile === e.customerId);
                return c?.type === 'supplier' && e.date === today;
            }).reduce((s, e) => s + (e.amount || 0), 0);
            
            const milkSold = localData.entries.filter(e => {
                const c = localData.customers.find(cu => cu.mobile === e.customerId);
                return c?.type === 'buyer' && e.date === today;
            }).reduce((s, e) => s + (e.amount || 0), 0);
            
            const netProfitToday = milkSold - milkCollected;
            
            const currentMonth = new Date().toISOString().substring(0, 7);
            const monthlyMilkSold = localData.entries.filter(e => {
                const c = localData.customers.find(cu => cu.mobile === e.customerId);
                return c?.type === 'buyer' && e.date.startsWith(currentMonth);
            }).reduce((s, e) => s + (e.amount || 0), 0);
            
            const monthlyMilkCollected = localData.entries.filter(e => {
                const c = localData.customers.find(cu => cu.mobile === e.customerId);
                return c?.type === 'supplier' && e.date.startsWith(currentMonth);
            }).reduce((s, e) => s + (e.amount || 0), 0);
            
            const monthlyNetProfit = monthlyMilkSold - monthlyMilkCollected;
            
            const totalBuyers = localData.customers.filter(c => c.type === 'buyer').length;
            const totalSellers = localData.customers.filter(c => c.type === 'supplier').length;

            grid.innerHTML = `
                <div class="stat-card">
                    <p>Milk Collected Today</p>
                    <div class="stat-value" style="color:#2563eb;">‚Çπ${milkCollected.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <p>Milk Sold Today</p>
                    <div class="stat-value" style="color:#2563eb;">‚Çπ${milkSold.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <p>Net Profit Today</p>
                    <div class="stat-value" style="color:${netProfitToday >= 0 ? '#059669' : '#b91c1c'};">‚Çπ${netProfitToday.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <p>Monthly Net Profit</p>
                    <div class="stat-value" style="color:${monthlyNetProfit >= 0 ? '#059669' : '#b91c1c'};">‚Çπ${monthlyNetProfit.toFixed(2)}</div>
                </div>
                <div class="stat-card">
                    <p>Total Buyers</p>
                    <div class="stat-value" style="color:#2563eb;">${totalBuyers}</div>
                </div>
                <div class="stat-card">
                    <p>Total Sellers</p>
                    <div class="stat-value" style="color:#2563eb;">${totalSellers}</div>
                </div>
            `;
        }

        function renderCustomers() {
            const grid = document.getElementById('customersGrid');
            if (!grid) return;
            if (!localData.customers.length) {
                grid.innerHTML = '<div style="padding:2rem; text-align:center; color:#6b7280;">No customers yet</div>';
                return;
            }
            grid.innerHTML = '';
            localData.customers.forEach(c => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                card.addEventListener('click', () => viewCustomerDetails(c.mobile));
                const isSupplier = c.type === 'supplier';
                const bgColor = isSupplier ? 'linear-gradient(135deg,#f59e0b,#d97706)' : 'linear-gradient(135deg,#3b82f6,#8b5cf6)';
                
                card.innerHTML = `
                    <div class="customer-card-header">
                        <div class="customer-avatar" style="background:${bgColor};">${c.name[0]}</div>
                        <div class="customer-info">
                            <div class="customer-name">${c.name}</div>
                            <div class="customer-meta">
                                <span class="customer-badge" style="background:${isSupplier ? '#fed7aa' : '#dbeafe'}; color:${isSupplier ? '#92400e' : '#1e40af'};">${isSupplier ? 'Seller' : 'Buyer'}</span>
                                ${c.mobile}
                            </div>
                        </div>
                    </div>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding-top:0.5rem;">
                        <div>
                            <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.2rem;">Balance</div>
                            <div class="balance-amount" style="color:${c.balance > 0 ? '#b91c1c' : '#065f46'};">‚Çπ${Math.abs(c.balance || 0).toFixed(2)}</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.2rem;">Rate/L</div>
                            <div style="font-weight:700;">‚Çπ${c.rate || 0}</div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        function viewCustomerDetails(mobile) {
            currentCustomerMobile = mobile;
            const customer = localData.customers.find(c => c.mobile === mobile);
            if (!customer) return;
            
            changeView('customerDetailView');
            
            const entries = localData.entries.filter(e => e.customerId === mobile);
            const payments = localData.payments.filter(p => p.customerId === mobile);
            const isSupplier = customer.type === 'supplier';
            
            const entriesHTML = entries.length ? entries.map(e => `
                <div class="entry-row">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.3rem;">
                        <strong>${e.date} (${e.time})</strong>
                        <strong style="color:${isSupplier ? '#059669' : '#b91c1c'};">‚Çπ${e.amount.toFixed(2)}</strong>
                    </div>
                    <div style="color:#6b7280; font-size:0.85rem;">${e.milkType} ‚Ä¢ ${e.liters}L @ ‚Çπ${e.rate}/L</div>
                </div>
            `).join('') : '<div style="padding:1rem; color:#6b7280; text-align:center;">No entries</div>';

            const paymentsHTML = payments.length ? payments.map(p => `
                <div class="payment-row">
                    <div style="display:flex; justify-content:space-between; margin-bottom:0.3rem;">
                        <strong>${p.date}</strong>
                        <strong style="color:${p.type === 'taken' ? '#059669' : '#b91c1c'};">${p.type === 'taken' ? '+' : '-'}‚Çπ${p.amount.toFixed(2)}</strong>
                    </div>
                    <div style="color:#6b7280; font-size:0.85rem;">${p.method}${p.transactionId ? ' ‚Ä¢ ' + p.transactionId : ''}</div>
                </div>
            `).join('') : '<div style="padding:1rem; color:#6b7280; text-align:center;">No payments</div>';

            const bgColor = isSupplier ? 'linear-gradient(135deg,#f59e0b,#d97706)' : 'linear-gradient(135deg,#3b82f6,#8b5cf6)';

            document.getElementById('customerDetailContent').innerHTML = `
                <div class="invoice-section">
                    <div style="display:flex; align-items:center; gap:1rem; margin-bottom:1rem;">
                        <div style="width:60px; height:60px; border-radius:50%; background:${bgColor}; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:700; font-size:1.5rem;">${customer.name[0]}</div>
                        <div>
                            <h2 style="font-size:1.3rem; font-weight:700; margin:0;">${customer.name}</h2>
                            <div style="color:#6b7280; font-size:0.95rem;">${customer.mobile} ‚Ä¢ ${isSupplier ? 'Seller' : 'Buyer'}</div>
                        </div>
                    </div>
                    <div style="display:grid; grid-template-columns:repeat(auto-fit, minmax(150px, 1fr)); gap:0.75rem;">
                        <div style="background:#f9fafb; padding:0.75rem; border-radius:0.4rem;">
                            <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.25rem;">Balance</div>
                            <div style="font-size:1.2rem; font-weight:700; color:${customer.balance > 0 ? '#b91c1c' : '#065f46'};">‚Çπ${Math.abs(customer.balance).toFixed(2)}</div>
                        </div>
                        <div style="background:#f9fafb; padding:0.75rem; border-radius:0.4rem;">
                            <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.25rem;">Rate/L</div>
                            <div style="font-size:1.2rem; font-weight:700;">‚Çπ${customer.rate || 0}</div>
                        </div>
                        <div style="background:#f9fafb; padding:0.75rem; border-radius:0.4rem;">
                            <div style="font-size:0.8rem; color:#6b7280; margin-bottom:0.25rem;">Entries</div>
                            <div style="font-size:1.2rem; font-weight:700;">${entries.length}</div>
                        </div>
                    </div>
                </div>
                <div class="invoice-section">
                    <h3 style="font-weight:700; margin-bottom:0.75rem; font-size:1rem;">Milk Entries (${entries.length})</h3>
                    ${entriesHTML}
                </div>
                <div class="invoice-section">
                    <h3 style="font-weight:700; margin-bottom:0.75rem; font-size:1rem;">Payment History (${payments.length})</h3>
                    ${paymentsHTML}
                </div>
            `;
        }

        function renderEntries() {
            const container = document.getElementById('entriesContainer');
            if (!container) return;
            if (!localData.entries.length) {
                container.innerHTML = '<div style="padding:2rem; text-align:center; color:#6b7280;">No entries yet</div>';
                return;
            }
            container.innerHTML = localData.entries.map(e => {
                const c = localData.customers.find(cu => cu.mobile === e.customerId);
                const isSupplier = c?.type === 'supplier';
                return `
                <div class="customer-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:700;">${e.customerName} ${isSupplier ? '(Seller)' : '(Buyer)'}</div>
                            <div style="font-size:0.85rem; color:#6b7280; margin-top:0.25rem;">${e.date} ‚Ä¢ ${e.time} ‚Ä¢ ${e.milkType}</div>
                            <div style="font-size:0.85rem; color:#6b7280;">${e.liters}L @ ‚Çπ${e.rate}/L</div>
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700; color:${isSupplier ? '#059669' : '#b91c1c'};">‚Çπ${e.amount.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function renderPayments() {
            const container = document.getElementById('paymentsContainer');
            if (!container) return;
            if (!localData.payments.length) {
                container.innerHTML = '<div style="padding:2rem; text-align:center; color:#6b7280;">No payments yet</div>';
                return;
            }
            container.innerHTML = localData.payments.map(p => {
                const c = localData.customers.find(cu => cu.mobile === p.customerId);
                const isTaken = p.type === 'taken';
                return `
                <div class="customer-card">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div>
                            <div style="font-weight:700;">${p.customerName} ${c?.type === 'supplier' ? '(Seller)' : '(Buyer)'}</div>
                            <div style="font-size:0.85rem; color:#6b7280; margin-top:0.25rem;">${p.date} ‚Ä¢ ${p.method}${p.transactionId ? ' ‚Ä¢ ' + p.transactionId : ''}</div>
                            ${p.note ? `<div style="font-size:0.85rem; color:#6b7280;">Note: ${p.note}</div>` : ''}
                        </div>
                        <div style="text-align:right;">
                            <div style="font-weight:700; color:${isTaken ? '#059669' : '#b91c1c'};">${isTaken ? '+' : '-'}‚Çπ${p.amount.toFixed(2)}</div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        function changeView(viewName, el) {
            document.querySelectorAll('.view-container').forEach(v => v.classList.remove('active'));
            const target = document.getElementById(viewName + 'View');
            if (target) target.classList.add('active');

            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            if (el) el.classList.add('active');

            if (viewName === 'customers') renderCustomers();
            if (viewName === 'entries') renderEntries();
            if (viewName === 'payments') renderPayments();
            if (viewName === 'dashboard') renderDashboard();

            document.getElementById('headerTitle').textContent = {
                'dashboard': 'Dashboard',
                'customers': 'Customers',
                'entries': 'Entries',
                'payments': 'Payments',
                'customerDetailView': 'Customer Details'
            }[viewName] || 'Anish Dairy';

            if (window.innerWidth < 768) toggleSidebar(false);
        }

        function updateBottomNav(idx) {
            document.querySelectorAll('.nav-btn').forEach((btn, i) => {
                btn.classList.toggle('active', i === idx);
            });
        }

        function selectTime(time) {
            selectedTime = time;
            document.querySelectorAll('.time-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.time === time);
            });
        }

        function openModal(type) {
            const modal = document.getElementById('modalOverlay');
            const title = document.getElementById('modalTitle');
            const content = document.getElementById('modalContent');

            if (type === 'customer') {
                title.textContent = 'Add Customer';
                content.innerHTML = getCustomerForm();
            } else if (type === 'entry') {
                title.textContent = 'Add Entry';
                selectedTime = 'morning';
                content.innerHTML = getEntryForm();
                setTimeout(() => {
                    document.querySelectorAll('.time-option').forEach(opt => {
                        opt.addEventListener('click', function() {
                            selectTime(this.dataset.time);
                        });
                    });
                }, 50);
            } else if (type === 'payment') {
                title.textContent = 'Record Payment';
                content.innerHTML = getPaymentForm();
            }
            modal.classList.add('active');
        }

        function closeModal() {
            document.getElementById('modalOverlay').classList.remove('active');
        }

        function getCustomerForm(edit) {
            const e = edit || {};
            return `
                <form onsubmit="${edit ? `updateCustomer(event, '${e.mobile}')` : 'addCustomer(event)'}; return false;">
                    <div class="form-group"><label class="form-label">Name *</label><input class="form-input" name="name" value="${e.name || ''}" required></div>
                    <div class="form-group"><label class="form-label">Mobile *</label><input class="form-input" name="mobile" value="${e.mobile || ''}" ${edit ? 'readonly' : ''} required></div>
                    <div class="form-group"><label class="form-label">Email</label><input class="form-input" type="email" name="email" value="${e.email || ''}"></div>
                    <div class="form-group"><label class="form-label">Address</label><input class="form-input" name="address" value="${e.address || ''}"></div>
                    <div class="form-group"><label class="form-label">Type *</label>
                    <select class="form-select" name="type" required>
                    <option value="buyer"${e.type==='buyer'?' selected':''}>Buyer</option>
                    <option value="supplier"${e.type==='supplier'?' selected':''}>Supplier</option>
                    </select>
                    </div>
                    <div class="form-group"><label class="form-label">Rate (‚Çπ/L) *</label><input class="form-input" name="rate" type="number" step="0.01" value="${e.rate || 45}" required></div>
                    <div style="display:flex; gap:.75rem; margin-top:1rem;">
                    <button type="button" class="btn btn-secondary" style="width:auto;" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary" style="width:auto;">${edit ? 'Update' : 'Add'}</button>
                    </div>
                </form>
            `;
        }

        function getEntryForm() {
            const opts = localData.customers.map(c => `<option value="${c.mobile}">${c.name} (‚Çπ${c.rate}/L)</option>`).join('');
            return `
                <form onsubmit="addEntry(event); return false;">
                    <div class="form-group">
                        <label class="form-label">Time *</label>
                        <div class="time-selector">
                            <div class="time-option selected" data-time="morning">üåÖ Morning</div>
                            <div class="time-option" data-time="evening">üåÜ Evening</div>
                        </div>
                    </div>
                    <div class="form-group"><label class="form-label">Customer *</label>
                        <select class="form-select" name="customerId" id="entryCustomer" required onchange="updateEntryRate()">
                            <option value="">Select Customer</option>${opts}
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Date *</label><input class="form-input" type="date" name="date" required value="${new Date().toISOString().split('T')[0]}"></div>
                    <div class="form-group"><label class="form-label">Milk Type *</label>
                        <select class="form-select" name="milkType"><option value="cow">Cow</option><option value="buffalo">Buffalo</option></select>
                    </div>
                    <div class="form-group"><label class="form-label">Liters *</label><input class="form-input" id="entryLiters" name="liters" type="number" step="0.1" required oninput="calcEntryAmount()"></div>
                    <div class="form-group"><label class="form-label">Rate (‚Çπ/L) *</label><input class="form-input" id="entryRate" name="rate" type="number" step="0.01" required readonly style="background:#f3f4f6;"></div>
                    <div class="form-group"><label class="form-label">Amount (‚Çπ)</label><input class="form-input" id="entryAmount" readonly style="background:#f3f4f6; font-weight:700;" value="0.00"></div>
                    <div style="display:flex; gap:.75rem; margin-top:1rem;">
                        <button type="button" class="btn btn-secondary" style="width:auto;" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="width:auto;">Add Entry</button>
                    </div>
                </form>
            `;
        }

        function updateEntryRate() {
            const mobile = document.getElementById('entryCustomer')?.value;
            const customer = localData.customers.find(c => c.mobile === mobile);
            if (customer) {
                const r = document.getElementById('entryRate');
                if (r) r.value = customer.rate || 0;
                calcEntryAmount();
            }
        }

        function calcEntryAmount() {
            const liters = parseFloat(document.getElementById('entryLiters')?.value || 0) || 0;
            const rate = parseFloat(document.getElementById('entryRate')?.value || 0) || 0;
            const amountEl = document.getElementById('entryAmount');
            if (amountEl) amountEl.value = (liters * rate).toFixed(2);
        }

        function getPaymentForm() {
            const opts = localData.customers.map(c => `<option value="${c.mobile}" data-type="${c.type}">${c.name} (${c.type === 'buyer' ? 'Buyer' : 'Seller'}) - Bal: ‚Çπ${(c.balance||0).toFixed(2)}</option>`).join('');
            return `
                <form onsubmit="addPayment(event); return false;">
                    <div class="form-group"><label class="form-label">Customer *</label>
                        <select class="form-select" name="customerId" id="paymentCustomer" required onchange="updatePaymentType()"><option value="">Select</option>${opts}</select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Payment Type *</label>
                        <select class="form-select" name="paymentType" id="paymentType" required>
                            <option value="taken">Payment Taken (+ Wallet)</option>
                            <option value="given">Payment Given (- Wallet)</option>
                        </select>
                    </div>
                    <div class="form-group"><label class="form-label">Date *</label><input class="form-input" type="date" name="date" required value="${new Date().toISOString().split('T')[0]}"></div>
                    <div class="form-group"><label class="form-label">Amount (‚Çπ) *</label><input class="form-input" name="amount" type="number" step="0.01" required></div>
                    <div class="form-group"><label class="form-label">Method *</label>
                        <select class="form-select" name="method" id="paymentMethod" required onchange="toggleTransactionId()">
                            <option>Cash</option>
                            <option>UPI</option>
                            <option>Card</option>
                            <option>Bank Transfer</option>
                            <option>Cheque</option>
                        </select>
                    </div>
                    <div class="form-group" id="transactionIdGroup" style="display:none;">
                        <label class="form-label">Transaction ID</label>
                        <input class="form-input" name="transactionId" placeholder="Optional">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Note</label>
                        <input class="form-input" name="note" placeholder="Optional note">
                    </div>
                    <div style="display:flex; gap:.75rem; margin-top:1rem;">
                        <button type="button" class="btn btn-secondary" style="width:auto;" onclick="closeModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" style="width:auto;">Record Payment</button>
                    </div>
                </form>
            `;
        }

        function updatePaymentType() {
            const select = document.getElementById('paymentCustomer');
            const option = select.options[select.selectedIndex];
            const customerType = option.dataset.type;
            const paymentType = document.getElementById('paymentType');
            
            if (customerType === 'buyer') {
                paymentType.value = 'taken';
            } else if (customerType === 'supplier') {
                paymentType.value = 'given';
            }
        }

        function toggleTransactionId() {
            const method = document.getElementById('paymentMethod').value;
            const group
