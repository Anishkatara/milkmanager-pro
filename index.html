<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<title>Anish Dairy – Milk Manager | Anish Katara</title>

<meta name="description" content="Anish Dairy Milk Manager by Anish Katara. Manage buyers, sellers, milk entries, payments and generate professional milk bills with UPI QR." />
<meta name="keywords" content="Anish Dairy, Anish Katara, Katara Dairy, Milk Manager, Dairy Billing App" />
<meta name="author" content="Anish Katara">
<meta name="robots" content="index, follow">

<!-- Firebase (v10 compat for new features) -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<!-- PDF & QR -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<style>
body{
  margin:0;
  font-family:Arial, sans-serif;
  background:#f4f7fb;
  color:#111827;
}
.hidden{display:none}
.center{
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}
.card{
  background:#fff;
  padding:24px;
  border-radius:16px;
  text-align:center;
  box-shadow:0 10px 30px rgba(0,0,0,0.15);
}
input,select{
  width:100%;
  padding:12px;
  margin:8px 0;
  border-radius:10px;
  border:1px solid #ccc;
}
button{
  width:100%;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#2563eb;
  color:#fff;
  font-weight:bold;
  cursor:pointer;
}
.app{
  display:flex;
  min-height:100vh;
}
.sidebar{
  width:220px;
  background:#fff;
  padding:20px;
  border-right:1px solid #e5e7eb;
}
.sidebar p{
  cursor:pointer;
  margin:10px 0;
}
.main{
  flex:1;
  padding:20px;
}
.bill{
  max-width:800px;
  margin:auto;
  background:#fff;
  padding:24px;
  border-radius:12px;
}
.bill h1{text-align:center}
.bill table{
  width:100%;
  border-collapse:collapse;
  margin-top:10px;
}
.bill th,.bill td{
  border:1px solid #e5e7eb;
  padding:8px;
  font-size:14px;
}
.qr{text-align:center;margin-top:16px}
.error{color:red;font-size:14px;margin-top:6px}
</style>
</head>

<body>

<!-- LOGIN SCREEN -->
<div id="loginBox" class="center">
  <div class="card" style="width:320px;">
    <img src="dairy_logo.png" width="90" style="border-radius:50%;margin-bottom:10px">
    <h2>Anish Dairy</h2>
    <input id="email" type="email" placeholder="Email">
    <input id="password" type="password" placeholder="Password">
    <button onclick="login()">Login</button>
    <div id="error" class="error"></div>
  </div>
</div>

<!-- APP SCREEN -->
<div id="app" class="hidden app">
  <div class="sidebar">
    <h3>Anish Dairy</h3>
    <p onclick="showBill()">Generate Bill</p>
    <p onclick="logout()">Logout</p>
  </div>

  <div class="main">
    <h2>Generate Bill</h2>
    <select id="customerSelect"></select>
    <button onclick="generateBill()">Generate Bill</button>

    <div id="billArea" class="bill hidden">
      <h1>ANISH DAIRY</h1>
      <p id="customerInfo"></p>

      <table>
        <thead>
          <tr>
            <th>Date</th>
            <th>Session</th>
            <th>Milk</th>
            <th>Qty</th>
            <th>Rate</th>
            <th>Amount</th>
          </tr>
        </thead>
        <tbody id="billEntries"></tbody>
      </table>

      <h3 id="finalBalance"></h3>
      <p id="statusText"></p>

      <div class="qr">
        <div id="qr"></div>
        <p>Scan & Pay (UPI)</p>
      </div>

      <button onclick="downloadPDF()">Download PDF</button>
    </div>
  </div>
</div>

<script>
/* ================= FIREBASE CONFIG ================= */
firebase.initializeApp({
  apiKey: "AIzaSyA6bK8TZkVqlyeRw-etHi-MxznRW8jBPJQ",
  authDomain: "anish-milk-app.firebaseapp.com",
  databaseURL: "https://anish-milk-app-default-rtdb.asia-southeast1.firebasedatabase.app/",
  projectId: "anish-milk-app",
  appId: "1:17384087601:web:83db1f8b77780ffde6b510"
});

const auth = firebase.auth();
const db = firebase.database();
const UPI_ID = "katara.anish@axl";

/* ================= AUTH ================= */
auth.onAuthStateChanged(user=>{
  if(user){
    loginBox.classList.add("hidden");
    app.classList.remove("hidden");
    loadCustomers();
  }else{
    app.classList.add("hidden");
    loginBox.classList.remove("hidden");
  }
});

function login(){
  error.innerText="";
  const e = email.value.trim();
  const p = password.value.trim();
  if(!e || !p){ error.innerText="Please enter email and password"; return; }

  auth.signInWithEmailAndPassword(e,p)
      .catch(err=>error.innerText=err.message);
}

function logout(){
  auth.signOut();
}

/* ================= CUSTOMERS ================= */
function loadCustomers(){
  customerSelect.innerHTML="";
  db.ref("customers").once("value",snap=>{
    snap.forEach(c=>{
      const o=document.createElement("option");
      o.value=c.key;
      o.text=c.val().name+" ("+c.val().type+")";
      customerSelect.appendChild(o);
    });
  });
}

/* ================= BILL ================= */
function generateBill(){
  const cid = customerSelect.value;
  let milkTotal=0,taken=0,given=0;
  billEntries.innerHTML="";

  db.ref("entries").once("value",snap=>{
    snap.forEach(e=>{
      const v=e.val();
      if(v.customerId===cid){
        milkTotal+=Number(v.amount);
        billEntries.innerHTML+=`
          <tr>
            <td>${v.date}</td>
            <td>${v.session}</td>
            <td>${v.milkType}</td>
            <td>${v.qty}</td>
            <td>${v.rate}</td>
            <td>${v.amount}</td>
          </tr>`;
      }
    });

    db.ref("payments").once("value",ps=>{
      ps.forEach(p=>{
        const v=p.val();
        if(v.customerId===cid){
          if(v.type==="taken") taken+=Number(v.amount);
          if(v.type==="given") given+=Number(v.amount);
        }
      });

      const balance = milkTotal - taken + given;

      finalBalance.innerText="Final Balance: ₹"+balance;
      statusText.innerText =
        balance>0 ? "Customer has to pay" :
        balance<0 ? "You have to pay customer" :
        "Account settled";

      qr.innerHTML="";
      new QRCode(qr,{
        text:`upi://pay?pa=${UPI_ID}&am=${Math.abs(balance)}`,
        width:160,
        height:160
      });

      billArea.classList.remove("hidden");
    });
  });
}

function downloadPDF(){
  const { jsPDF } = window.jspdf;
  new jsPDF().html(billArea,{
    callback: pdf=>pdf.save("Anish_Dairy_Bill.pdf"),
    x:10, y:10
  });
}

function showBill(){
  billArea.classList.add("hidden");
}
</script>

</body>
</html>
